name: Security Scan - Gitleaks

on:
  # Run weekly on Mondays at 00:00 UTC
  schedule:
    - cron: '0 0 * * 1'
  
  # Allow manual trigger
  workflow_dispatch:
  
  # Run on every push to main and PRs
  push:
    branches:
      - main
      - copilot/**
  pull_request:
    branches:
      - main

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  gitleaks-scan:
    name: Gitleaks Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for comprehensive scanning
      
      - name: Run Gitleaks scan
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Optional for enterprise features
        continue-on-error: true
      
      - name: Upload Gitleaks SARIF report
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: gitleaks
        continue-on-error: true
      
      - name: Check scan results
        if: steps.gitleaks.outcome == 'failure'
        run: |
          echo "âš ï¸ SECURITY ALERT: Gitleaks found potential secrets!"
          echo "Please review the scan results and take immediate action."
          echo "Results are available in the Security tab."
          exit 1
      
      - name: Success notification
        if: steps.gitleaks.outcome == 'success'
        run: |
          echo "âœ… Security scan completed successfully"
          echo "No secrets detected in the repository"
  
  trufflehog-scan:
    name: TruffleHog Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run TruffleHog scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified
        continue-on-error: true
  
  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [gitleaks-scan, trufflehog-scan]
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create security summary
        run: |
          echo "## ðŸ” Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.gitleaks-scan.result }}" = "success" ] && [ "${{ needs.trufflehog-scan.result }}" = "success" ]; then
            echo "âœ… **Status:** All security scans passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No secrets detected in the repository." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Status:** Security issues detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the scan results and take immediate action." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Actions Required:" >> $GITHUB_STEP_SUMMARY
            echo "1. Review detected secrets in the Security tab" >> $GITHUB_STEP_SUMMARY
            echo "2. Rotate compromised credentials immediately" >> $GITHUB_STEP_SUMMARY
            echo "3. Remove secrets from git history if needed" >> $GITHUB_STEP_SUMMARY
            echo "4. Update .gitignore to prevent future exposures" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Coverage:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Gitleaks: Detects secrets, API keys, tokens" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… TruffleHog: Verifies leaked credentials" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… All git history scanned" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ€ **Nexus Guardian D7D - Security First** ðŸŒ€" >> $GITHUB_STEP_SUMMARY
